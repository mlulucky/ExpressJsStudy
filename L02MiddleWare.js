const express=require("express");
const app=express(); // μ„λ²„ μƒμ„± + μ‹¤ν–‰
const fs=require("fs/promises"); // ν”„λ΅λ―Έμ¤ν™” λ νμΌμ‹μ¤ν…
//"/" index νμ΄μ§€λ¥Ό μ”μ²­ν•λ©΄ L02Index.html νμΌμ„ λ¶λ¬μ™€μ„ μ‘λ‹µν•μ„Έμ”!
// app.use : λ―Έλ“¤μ›¨μ–΄ (κ°μ‹ν•λ ¤κ³ )
// "*" : κ°€λ΅μ± μ”μ²­μ ν¨ν„΄ (* λ¨λ“  μ™€μΌλ“μΉ΄λ“)
// next : /a.do μ”μ²­μ„ λ―Έλ“¤μ›¨μ–΄κ°€ μ¤‘κ°„μ— κ°€λ΅μ±λ”λ° a.do λ΅ κ³„μ† κ°€λ ¤λ©΄ next() λ¥Ό νΈμ¶ν•λ©΄ λλ‹¤.
app.use("*",(req, res, next)=>{ // λ¨λ“  νμ΄μ§€μ μ”μ²­μ„ κ°€λ΅μ±λ‹¤
    console.log("* λ―Έλ“¤μ›¨μ–΄κ°€ κ°€λ΅μ±”!", req.originalUrl); // 2λ² κ°€λ΅μ±λ‹¤ // λΈλΌμ°μ € μλ„μ°μ μ•„μ΄μ½ favicon μ”μ²­ μ΄ μμ–΄μ„ λΈλΌμ°μ €κ°€ μ„λ²„μ—κ² μ”μ²­.
    next(); // μ›λ μ”μ²­ν•λ urlλ΅ μ΄λ™
});
app.use("/user/*",(req,res,next)=>{ // λ―Έλ“¤μ›¨μ–΄ : μ‚¬μ΄νΈ μ”μ²­μ„ κ°€λ΅μ±λ‹¤ / λ―Έλ“¤μ›¨μ–΄κ°€ λ¨Όμ € μ‹¤ν–‰λλ‹¤.
    console.log("/user/* λ―Έλ“¤μ›¨μ–΄κ°€ κ°€λ΅μ±”!",req.originalUrl); // user λ΅ μ¤λ” λ¨λ“  μ”μ²­μ„ κ°€λ΅μ±λ‹¤
    if(req.query.id) { // νλΌλ―Έν„° μ•„μ΄λ””κ°€ μμΌλ©΄
      next(); // μ μ €νμ΄μ§€λ΅ κ° μ μλ‹¤ // νμ΄μ§€ μ‘λ‹µ~!
   }
    else { // μ•„μ΄λ””κ°€ μ—†μΌλ©΄
        res.redirect("/"); // λ©”μΈνμ΄μ§€λ΅ μ΄λ™ // π’redirect : λ‹¤λ¥Ένμ΄μ§€λ΅ μ΄λ™
        // res.writeHead(302,{location:"/"});
       // res.end();
        // μµμ¤ν”„λ μ¤κ°€ λ…Έλ“λ¥Ό ν’κ³ μλ‹¤.
        // ν”„λ μ„μ›ν¬
        // λ―Έλ“¤μ›¨μ–΄λ” λ°©ν¨ λ²½(λ¬Έμ§€κΈ°) // (/user/* ) κ°μ‹ - λ„ νλΌλ―Έν„°κ°€ μ—†λ‹¤. / μλ‹¤? λ¬Έμ„ μ—΄μ–΄μ£Όκ³  - μ‘λ‹µν•λ‹¤.
        // μ‹¤ν–‰μ΄ ν•λ‹¨κ³„ λ” μƒκΈ΄κ±°
        // μ„λ²„ λΈλΌμ°μ €μ κ΄€κ³„ - μ”μ²­ / μ„λ²„μ—μ„ μ°Ύμ•„μ„ μ‘λ‹µ == μ›Ήμ•±μ„λ²„
        // μµμ¤ν”„λ μ¤ μ›Ήμ•±μ„λ²„ - λ―Έλ“¤μ›¨μ–΄ - urlλ΅ κ²€μ‚¬ -> μ „λ¶€λ‹¤ κ²€μ‚¬. νΉμ •μ”μ²­μ΄ μ•„λ‹λΌ κ΄‘λ²”μ„ν• μ”μ²­μ„ μ²λ¦¬ν•λ” κ²ƒ!
        // ν΄λ”λ§λ‹¤ κ²€μ‚¬ κ°€λ¥ => /a/b/c.do => */b/* λ¨λ“ μ”μ²­μ— bκ°€ μ¤λ” λ¨λ“  νμΌ
        // κ²€μ‚¬ ν›„ νΉμ •νμ΄μ§€λ¥Ό μ‘λ‹µν•  μ μκ²ν•λ‹¤.
        // λ―Έλ“¤μ›¨μ–΄ - λΌμ΄λΈλ¬λ¦¬ - μ—¬λ¬λ² μ΅°κ±΄μ„ μ¤„ μ μλ‹¤. app.use() λ¥Ό μ—¬λ¬κ° λ§λ“¤κΈ°! // μ‹¤ν–‰μμ„λ” μ„μ—μ„ μ•„λλ΅ μ¨λ†“μ€ μμ„λ€λ΅ μ‹¤ν–‰.
        //
   }
});

app.get("/a.do",(req, res)=>{
    res.send("<h1>* λ―Έλ“¤μ›¨μ–΄κ°€ λ¨λ“  νμ΄μ§€λ¥Ό κ°μ‹ν•©λ‹λ‹¤.</h1>")
});

app.get("/user/b.do",(req, res)=>{
   res.send("<h1>/user/b.do νμ΄μ§€ (/user/* μ μ €ν΄λ” μ•μ λ¨λ“  λ¦¬μ†μ¤λ” νλΌλ―Έν„° idκ°€ κΌ­ ν•„μ”)</h1>")
});

app.get("/user/c.do",(req, res)=>{
    res.send("<h1>/user/c.do νμ΄μ§€ (/user/* μ μ €ν΄λ” μ•μ λ¨λ“  λ¦¬μ†μ¤λ” νλΌλ―Έν„° idκ°€ κΌ­ ν•„μ”)</h1>")
});

// "/" index νμ΄μ§€λ¥Ό μ”μ²­ν•λ©΄ L02Index.html νμΌμ„ λ¶λ¬μ™€μ„ μ‘λ‹µν•μ„Έμ”
// fs. ν”„λ΅λ―Έμ¤ν™” // λΉ„λ™κΈ°ν†µμ‹  ajax // url μ „ν™μ—†μ΄ μ„λ²„μ™€ ν†µμ‹ ν•΄μ„ νμ΄μ§€ λ¶λ¬μ¤κΈ°
app.get("/", async (req,res)=>{
    let data=await fs.readFile("L02Index.html");
    res.write(data);
    res.end();
})

app.listen(7777, ()=>{ // μ„μΉ λ§¨μ•„λ. λ§¨μ„ μƒκ΄€μ—†λ‹¤.
    console.log("http://localhost:7777 μ— λ―Έλ“¤μ›¨μ–΄ μμ—…");
});